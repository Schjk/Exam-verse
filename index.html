<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE Mock CBT - AI Powered</title>
    <style>
        /* CSS: This controls how the app looks */
        :root {
            --primary: #007bff;
            --header-height: 60px;
            --palette-width: 280px;
        }
        
        body { margin: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        /* Layout */
        header {
            height: var(--header-height);
            background: #fff;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .question-area {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }
        
        .sidebar {
            width: var(--palette-width);
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        
        /* Question Palette Grid */
        .palette-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 10px;
            overflow-y: auto;
        }
        
        .q-btn {
            height: 40px;
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Status Colors (JEE Standard) */
        .q-btn.current { border: 2px solid #000; }
        .q-btn.answered { background: #28a745; color: white; border: none; }
        .q-btn.review { background: #6f42c1; color: white; border: none; }
        .q-btn.not-answered { background: #dc3545; color: white; border: none; }
        
        /* Footer controls */
        .footer-controls {
            padding: 10px;
            border-top: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
        }
        
        .btn { padding: 8px 16px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold;}
        .btn-save { background: #28a745; }
        .btn-clear { background: #dc3545; }
        .btn-ai { background: linear-gradient(45deg, #4285F4, #AA00FF); margin-top: 10px; width: 100%; }

        /* Timer */
        #timer { font-size: 1.2rem; font-weight: bold; color: #333; }
        
        /* AI Modal */
        #ai-response {
            background: #f0f8ff;
            padding: 10px;
            border-left: 4px solid #4285F4;
            margin-top: 15px;
            display: none;
            font-style: italic;
        }
    </style>
</head>
<body>

<header>
    <h3>ExamVerse CBT (Demo)</h3>
    <div id="timer">Time Left: 180:00</div>
</header>

<div class="main-container">
    <div class="question-area">
        <div id="question-text">
            <h3>Question <span id="q-num">1</span></h3>
            <p id="q-content">Loading question...</p>
        </div>
        
        <div id="options-container">
            </div>

        <button class="btn btn-ai" onclick="askAI()">‚ú® Ask AI for a Hint</button>
        <div id="ai-response"></div>
    </div>

    <div class="sidebar">
        <div style="padding: 10px; background: #e9ecef; font-weight: bold;">Question Palette</div>
        <div class="palette-grid" id="palette">
            </div>
        <div style="margin-top: auto; padding: 10px; background: #fff;">
            <p>Legend:</p>
            <span style="color:#28a745">‚ñ† Answered</span><br>
            <span style="color:#dc3545">‚ñ† Not Answered</span>
        </div>
    </div>
</div>

<div class="footer-controls">
    <button class="btn btn-clear" onclick="clearResponse()">Clear</button>
    <button class="btn btn-save" onclick="saveAndNext()">Save & Next</button>
</div>

<script>
    // --- MOCK DATA (Ideally this comes from a Database) ---
    const questions = [
        { id: 1, text: "If f(x) = x^2, what is f'(x)?", options: ["x", "2x", "x^2", "0"], correct: 1, hint: "Use the power rule: d/dx (x^n) = n*x^(n-1)." },
        { id: 2, text: "The dimensions of Planck's Constant are:", options: ["ML2T-1", "MLT-1", "ML2T-2", "M0L0T0"], correct: 0, hint: "E = hv. So h = E/v. Dimensions of Energy / Frequency." },
        { id: 3, text: "Which is not a colligative property?", options: ["Osmotic Pressure", "Elevation in Boiling Point", "Vapor Pressure", "Depression in Freezing Point"], correct: 2, hint: "Colligative properties depend on the number of particles. Vapor pressure itself is not one, but 'Lowering of VP' is." }
    ];

    // --- STATE MANAGEMENT ---
    let currentQIndex = 0;
    let answers = {}; // Stores user answers: { 0: 1, 1: null }
    let status = {};  // Stores status: 'visited', 'answered'

    // --- INITIALIZATION ---
    function init() {
        renderPalette();
        loadQuestion(0);
        startTimer(180 * 60); // 3 hours
    }

    // --- CORE FUNCTIONS ---
    function loadQuestion(index) {
        currentQIndex = index;
        const q = questions[index];
        
        // Update UI
        document.getElementById('q-num').innerText = index + 1;
        document.getElementById('q-content').innerText = q.text;
        document.getElementById('ai-response').style.display = 'none'; // Hide old AI hint
        
        // Render Options
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        
        q.options.forEach((opt, i) => {
            const div = document.createElement('div');
            div.style.padding = "10px";
            div.style.border = "1px solid #ddd";
            div.style.marginBottom = "5px";
            
            // Check if previously selected
            if (answers[index] === i) {
                div.style.background = "#d1e7dd";
                div.style.borderColor = "#badbcc";
            }

            div.innerHTML = `<label><input type="radio" name="opt" value="${i}" ${answers[index] === i ? 'checked' : ''} onchange="selectOption(${i})"> ${opt}</label>`;
            container.appendChild(div);
        });

        updatePalette();
    }

    function selectOption(optionIndex) {
        answers[currentQIndex] = optionIndex;
    }

    function saveAndNext() {
        if (answers[currentQIndex] !== undefined) {
            status[currentQIndex] = 'answered';
        } else {
            status[currentQIndex] = 'not-answered';
        }
        
        if (currentQIndex < questions.length - 1) {
            loadQuestion(currentQIndex + 1);
        } else {
            alert("End of Test! Submit?");
        }
        updatePalette();
    }

    function clearResponse() {
        delete answers[currentQIndex];
        status[currentQIndex] = 'visited';
        loadQuestion(currentQIndex); // Re-render to clear selection
    }

    // --- PALETTE LOGIC ---
    function renderPalette() {
        const p = document.getElementById('palette');
        p.innerHTML = '';
        questions.forEach((_, i) => {
            const btn = document.createElement('button');
            btn.className = 'q-btn';
            btn.innerText = i + 1;
            btn.id = `p-btn-${i}`;
            btn.onclick = () => loadQuestion(i);
            p.appendChild(btn);
        });
    }

    function updatePalette() {
        questions.forEach((_, i) => {
            const btn = document.getElementById(`p-btn-${i}`);
            btn.className = 'q-btn'; // Reset
            
            if (i === currentQIndex) btn.classList.add('current');
            else if (status[i] === 'answered') btn.classList.add('answered');
            else if (status[i] === 'not-answered') btn.classList.add('not-answered');
        });
    }

    // --- REAL GEMINI AI INTEGRATION ---
    
    // ‚ö†Ô∏è SECURITY NOTE: In a real app, never store keys in frontend code.
    // We are doing this only for a demo.
    const API_KEY = "AIzaSyB7eliVGgyhiK1PxeYTizBAc4Yf6Ko3Fqo"; 

    async function askAI() {
        const box = document.getElementById('ai-response');
        const btn = document.querySelector('.btn-ai');
        
        // 1. UI Feedback: Show user we are working
        box.style.display = 'block';
        box.innerHTML = "<b>Thinking... (Contacting Google Servers)</b>";
        btn.disabled = true; // Prevent double clicking

        // 2. Prepare the Data (The Payload)
        const currentQuestion = questions[currentQIndex].text;
        const currentOptions = questions[currentQIndex].options.join(", ");
        
        // This is the "Prompt" we send to Gemini
        const prompt = `
            You are a helpful JEE Tutor. A student is stuck on this question:
            "${currentQuestion}"
            Options: ${currentOptions}.
            
            Do NOT give the direct answer.
            Give a small conceptual hint (max 2 lines) to help them solve it.
            Then provide the formula required.
        `;

        try {
            // 3. The Network Request (The API Call)
            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`,
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    }),
                }
            );

            // 4. Processing the Response
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }

            // Extracting the text from Gemini's complex JSON structure
            const aiText = data.candidates[0].content.parts[0].text;
            
            // 5. Display Result
            box.innerHTML = `<b>ü§ñ Gemini Hint:</b><br>${aiText.replace(/\n/g, '<br>')}`; // Format line breaks

        } catch (error) {
            console.error("API Error:", error);
            box.innerHTML = `<b style="color:red">Error:</b> Could not reach AI. Check your internet or API Key.`;
        } finally {
            btn.disabled = false; // Re-enable button
        }
    }


    // --- TIMER ---
    function startTimer(duration) {
        let timer = duration, minutes, seconds;
        setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            document.getElementById('timer').innerText = "Time Left: " + minutes + ":" + seconds;
            if (--timer < 0) timer = duration;
        }, 1000);
    }

    // Start App
    init();
</script>
</body>
</html>
